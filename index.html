import React, { useState, useEffect, useRef } from 'react';
import { Save, Play, Trash2, Plus, Settings, Table, FileText, Download, Copy, Info, Upload, ArrowRight, CheckCircle, AlertCircle, FileSpreadsheet } from 'lucide-react';

const SeTeukGenerator = () => {
  // --- 상태 관리 ---
  const [activeTab, setActiveTab] = useState('input'); // 'input', 'upload', 'result', 'settings'
  const [apiKey, setApiKey] = useState('');
  const [basePrompt, setBasePrompt] = useState('');
  const [modelType, setModelType] = useState('flash'); // 'flash' or 'pro'
  const [students, setStudents] = useState([]);
  const [results, setResults] = useState([]);
  const [isGenerating, setIsGenerating] = useState(false);
  const [generationProgress, setGenerationProgress] = useState(0);

  // --- 엑셀 자유양식 업로드 관련 상태 ---
  const [excelFile, setExcelFile] = useState(null);
  const [excelHeaders, setExcelHeaders] = useState([]);
  const [excelRows, setExcelRows] = useState([]);
  const [columnMapping, setColumnMapping] = useState({});
  const fileInputRef = useRef(null);

  // --- 상수 데이터 ---
  const MODELS = {
    flash: {
      id: 'gemini-2.5-flash-preview-09-2025',
      name: 'Gemini 2.5 Flash (Preview)',
      costInput: 0.075, // $ per 1M tokens
      costOutput: 0.30,
      desc: '빠른 속도, 저렴한 비용'
    },
    pro: {
      id: 'gemini-1.5-pro',
      name: 'Gemini 1.5 Pro',
      costInput: 3.50, // $ per 1M tokens (Approx standard pricing)
      costOutput: 10.50,
      desc: '높은 성능, 복잡한 추론'
    }
  };

  const FIELD_DEFINITIONS = [
    { key: 'grade', label: '학년', keywords: ['학년'] },
    { key: 'classNum', label: '반', keywords: ['반'] },
    { key: 'number', label: '번호', keywords: ['번호'] },
    { key: 'name', label: '이름 (필수)', keywords: ['이름', '성명'], required: true },
    { key: 'standard', label: '교과 성취기준', keywords: ['성취', '기준'] },
    { key: 'midterm', label: '중간고사', keywords: ['중간'] },
    { key: 'final', label: '기말고사', keywords: ['기말'] },
    { key: 'perf1Std', label: '수행1 성취기준', keywords: ['수행1', '과제1'] },
    { key: 'perf1Act', label: '수행1 활동내용', keywords: ['활동1', '내용1'] },
    { key: 'perf2Std', label: '수행2 성취기준', keywords: ['수행2', '과제2'] },
    { key: 'perf2Act', label: '수행2 활동내용', keywords: ['활동2', '내용2'] },
    { key: 'note', label: '비고', keywords: ['비고', '특이'] },
    { key: 'customPrompt', label: '개별 프롬프트', keywords: ['프롬프트', '추가'] },
  ];

  const DEFAULT_PROMPT = `당신은 학교 생활기록부의 '교과 세부능력 및 특기사항'을 작성하는 전문가입니다.
아래 제공된 학생의 성취기준, 시험 점수, 수행평가 활동 내용을 바탕으로 구체적이고 긍정적인 평가 문구를 작성해주세요.

[작성 원칙]
1. 학생의 활동과 성장이 잘 드러나게 서술형으로 작성할 것.
2. 미사여구보다는 구체적인 사실(팩트) 위주로 작성할 것.
3. 책 제목이 나올 경우 '책제목(저자)' 형식으로 작은따옴표를 사용하여 표기할 것. (공간이 부족하면 '책제목'만 표기)
4. 문장은 명확하게 끝맺음할 것 (~함, ~임 등으로 끝내지 말고 ~하였습니다 등으로 서술).
5. 전체 분량은 공백 포함 500자 ~ 700자 사이로 작성.`;

  // --- 초기화 및 CDN 로드 ---
  useEffect(() => {
    // SheetJS CDN 로드
    const script = document.createElement('script');
    script.src = "https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js";
    script.async = true;
    document.body.appendChild(script);

    // 로컬 스토리지 데이터 불러오기
    const savedApiKey = localStorage.getItem('gemini_api_key') || '';
    const savedPrompt = localStorage.getItem('gemini_base_prompt') || DEFAULT_PROMPT;
    const savedModel = localStorage.getItem('gemini_model_type') || 'flash';
    const savedStudents = JSON.parse(localStorage.getItem('gemini_students_data') || '[]');

    setApiKey(savedApiKey);
    setBasePrompt(savedPrompt);
    setModelType(savedModel);
    
    if (savedStudents.length > 0) {
      setStudents(savedStudents);
    } else {
      handleAddRow(3);
    }

    return () => {
      if (document.body.contains(script)) {
        document.body.removeChild(script);
      }
    };
  }, []);

  // --- 데이터 자동 저장 ---
  useEffect(() => { localStorage.setItem('gemini_api_key', apiKey); }, [apiKey]);
  useEffect(() => { localStorage.setItem('gemini_base_prompt', basePrompt); }, [basePrompt]);
  useEffect(() => { localStorage.setItem('gemini_model_type', modelType); }, [modelType]);
  useEffect(() => { localStorage.setItem('gemini_students_data', JSON.stringify(students)); }, [students]);

  // --- 핸들러 함수들 ---

  const handleAddRow = (count = 1) => {
    const newRows = Array.from({ length: count }).map(() => ({
      id: Date.now() + Math.random(),
      grade: '', classNum: '', number: '', name: '',
      standard: '', midterm: '', final: '',
      perf1Std: '', perf1Act: '',
      perf2Std: '', perf2Act: '',
      note: '', customPrompt: ''
    }));
    setStudents(prev => [...prev, ...newRows]);
  };

  const handleRemoveRow = (id) => {
    setStudents(prev => prev.filter(s => s.id !== id));
  };

  const handleInputChange = (id, field, value) => {
    setStudents(prev => prev.map(s => s.id === id ? { ...s, [field]: value } : s));
  };

  // --- 엑셀 자유양식 업로드 로직 ---

  const handleExcelFileRead = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (!window.XLSX) {
      alert('엑셀 라이브러리 로드 중입니다. 잠시 후 다시 시도해주세요.');
      return;
    }

    const reader = new FileReader();
    reader.onload = (evt) => {
      try {
        const data = new Uint8Array(evt.target.result);
        const workbook = window.XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        
        // JSON으로 변환 (헤더 포함 2차원 배열)
        const jsonData = window.XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        if (jsonData.length < 2) {
          alert('데이터가 없는 파일입니다.');
          return;
        }

        const headers = jsonData[0]; // 첫 번째 행을 헤더로 가정
        const rows = jsonData.slice(1);

        setExcelFile(file.name);
        setExcelHeaders(headers);
        setExcelRows(rows);
        
        // 스마트 자동 매칭
        const initialMapping = {};
        FIELD_DEFINITIONS.forEach(field => {
          // 헤더 중 키워드가 포함된 것이 있는지 확인
          const matchedHeaderIndex = headers.findIndex(h => 
            h && field.keywords.some(keyword => h.toString().includes(keyword))
          );
          if (matchedHeaderIndex !== -1) {
            initialMapping[field.key] = matchedHeaderIndex; // 인덱스로 저장
          } else {
             initialMapping[field.key] = ''; // 매칭 실패 시 공란
          }
        });
        setColumnMapping(initialMapping);

      } catch (error) {
        console.error(error);
        alert('파일을 읽는 중 오류가 발생했습니다.');
      }
    };
    reader.readAsArrayBuffer(file);
    e.target.value = ''; // 초기화
  };

  const handleApplyMappedData = () => {
    if (!columnMapping['name'] && columnMapping['name'] !== 0) {
      alert("'이름' 열은 필수입니다. 엑셀의 어느 열이 이름인지 선택해주세요.");
      return;
    }

    const newStudents = excelRows.map(row => {
      const student = { id: Date.now() + Math.random() };
      
      FIELD_DEFINITIONS.forEach(field => {
        const colIndex = columnMapping[field.key];
        if (colIndex !== '' && colIndex !== undefined) {
          student[field.key] = row[colIndex] || '';
        } else {
          student[field.key] = '';
        }
      });
      return student;
    }).filter(s => s.name); // 이름이 있는 경우만

    if (newStudents.length === 0) {
      alert('가져올 데이터가 없습니다. 매칭 상태를 확인해주세요.');
      return;
    }

    if (confirm(`${newStudents.length}명의 데이터를 입력 탭에 추가하시겠습니까?`)) {
      setStudents(prev => [...prev, ...newStudents]);
      setActiveTab('input');
      setExcelFile(null); // 업로드 상태 초기화
      setExcelRows([]);
    }
  };


  const calculateCost = (inputTokens, outputTokens) => {
    const model = MODELS[modelType];
    const inputCost = (inputTokens / 1000000) * model.costInput;
    const outputCost = (outputTokens / 1000000) * model.costOutput;
    return (inputCost + outputCost);
  };

  const generateSeTeuk = async () => {
    if (!apiKey) {
      alert('설정 탭에서 API 키를 먼저 입력해주세요.');
      setActiveTab('settings');
      return;
    }

    setIsGenerating(true);
    setActiveTab('result');
    setResults([]);
    let completedCount = 0;
    const newResults = [];
    const targetModelId = MODELS[modelType].id;

    for (const student of students) {
      if (!student.name) continue;

      try {
        const userContent = `
[학생 정보]
- 학년/반/번호/이름: ${student.grade}학년 ${student.classNum}반 ${student.number}번 ${student.name}
- 교과 성취기준: ${student.standard}
- 중간고사 점수: ${student.midterm}
- 기말고사 점수: ${student.final}
- 수행평가1 성취기준: ${student.perf1Std}
- 수행평가1 활동내용: ${student.perf1Act}
- 수행평가2 성취기준: ${student.perf2Std}
- 수행평가2 활동내용: ${student.perf2Act}
- 비고: ${student.note}

[추가 요청사항]
${student.customPrompt}
`;

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${targetModelId}:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{
              role: 'user',
              parts: [{ text: basePrompt + "\n" + userContent }]
            }],
            generationConfig: {
              temperature: 0.7,
              maxOutputTokens: 1000,
            }
          })
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error.message);

        const generatedText = data.candidates?.[0]?.content?.parts?.[0]?.text || "생성 실패";
        const usage = data.usageMetadata || { promptTokenCount: 0, candidatesTokenCount: 0, totalTokenCount: 0 };

        newResults.push({
          studentId: student.id,
          info: student,
          text: generatedText,
          usage: usage,
          status: 'success'
        });

      } catch (error) {
        newResults.push({
          studentId: student.id,
          info: student,
          text: `에러 발생: ${error.message}`,
          usage: { promptTokenCount: 0, candidatesTokenCount: 0, totalTokenCount: 0 },
          status: 'error'
        });
      }

      completedCount++;
      setGenerationProgress(Math.round((completedCount / students.filter(s => s.name).length) * 100));
      setResults([...newResults]);
    }

    setIsGenerating(false);
  };

  const copyToClipboard = (text) => {
    navigator.clipboard.writeText(text);
    alert('복사되었습니다.');
  };

  const totalUsage = results.reduce((acc, curr) => ({
    input: acc.input + (curr.usage?.promptTokenCount || 0),
    output: acc.output + (curr.usage?.candidatesTokenCount || 0),
  }), { input: 0, output: 0 });

  const totalCost = calculateCost(totalUsage.input, totalUsage.output);

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col font-sans">
      {/* 헤더 */}
      <header className="bg-indigo-600 text-white p-4 shadow-md flex justify-between items-center">
        <div className="flex items-center gap-2">
          <FileText size={24} />
          <h1 className="text-xl font-bold">AI 교과세특 생성기</h1>
        </div>
        <div className="flex gap-2">
          <button 
            onClick={() => setActiveTab('input')}
            className={`px-3 py-2 rounded-lg flex items-center gap-2 ${activeTab === 'input' ? 'bg-white text-indigo-600 font-bold' : 'hover:bg-indigo-500 text-indigo-100'}`}
          >
            <Table size={18} /> 데이터 입력
          </button>
          <button 
            onClick={() => setActiveTab('upload')}
            className={`px-3 py-2 rounded-lg flex items-center gap-2 ${activeTab === 'upload' ? 'bg-white text-indigo-600 font-bold' : 'hover:bg-indigo-500 text-indigo-100'}`}
          >
            <Upload size={18} /> 엑셀 업로드(자유양식)
          </button>
          <button 
            onClick={() => setActiveTab('result')}
            className={`px-3 py-2 rounded-lg flex items-center gap-2 ${activeTab === 'result' ? 'bg-white text-indigo-600 font-bold' : 'hover:bg-indigo-500 text-indigo-100'}`}
          >
            <Download size={18} /> 결과 및 비용
          </button>
          <button 
            onClick={() => setActiveTab('settings')}
            className={`px-3 py-2 rounded-lg flex items-center gap-2 ${activeTab === 'settings' ? 'bg-white text-indigo-600 font-bold' : 'hover:bg-indigo-500 text-indigo-100'}`}
          >
            <Settings size={18} /> 설정
          </button>
        </div>
      </header>

      {/* 메인 콘텐츠 */}
      <main className="flex-1 p-4 overflow-hidden flex flex-col">
        
        {/* 1. 설정 탭 */}
        {activeTab === 'settings' && (
          <div className="max-w-3xl mx-auto w-full bg-white rounded-lg shadow p-6 animate-fade-in">
            <h2 className="text-2xl font-bold mb-6 text-gray-800 border-b pb-2">환경 설정</h2>
            
            <div className="mb-6">
              <label className="block text-sm font-medium text-gray-700 mb-2">Gemini API Key</label>
              <input 
                type="password" 
                value={apiKey}
                onChange={(e) => setApiKey(e.target.value)}
                placeholder="AI Studio에서 발급받은 API Key를 입력하세요"
                className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 outline-none"
              />
            </div>

            <div className="mb-6">
              <label className="block text-sm font-medium text-gray-700 mb-2">사용 모델 선택</label>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {Object.entries(MODELS).map(([key, info]) => (
                  <div 
                    key={key}
                    onClick={() => setModelType(key)}
                    className={`border rounded-lg p-4 cursor-pointer transition-all ${modelType === key ? 'border-indigo-600 bg-indigo-50 ring-2 ring-indigo-200' : 'border-gray-200 hover:border-indigo-300'}`}
                  >
                    <div className="flex items-center justify-between mb-2">
                      <span className="font-bold text-gray-800">{info.name}</span>
                      {modelType === key && <span className="text-indigo-600 text-xs font-bold">선택됨</span>}
                    </div>
                    <div className="text-sm text-gray-600 mb-2">{info.desc}</div>
                    <div className="text-xs text-gray-500">
                      입력: ${info.costInput}/1M | 출력: ${info.costOutput}/1M
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div className="mb-6">
              <label className="block text-sm font-medium text-gray-700 mb-2">기본 시스템 프롬프트</label>
              <textarea 
                value={basePrompt}
                onChange={(e) => setBasePrompt(e.target.value)}
                rows={10}
                className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 outline-none font-mono text-sm"
              />
            </div>
            
            <div className="flex justify-end">
              <button 
                onClick={() => { localStorage.setItem('gemini_api_key', apiKey); alert('저장되었습니다.'); }}
                className="bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 flex items-center gap-2"
              >
                <Save size={18} /> 설정 저장
              </button>
            </div>
          </div>
        )}

        {/* 2. 자유양식 엑셀 업로드 탭 (신설) */}
        {activeTab === 'upload' && (
          <div className="flex flex-col h-full gap-4 max-w-5xl mx-auto w-full animate-fade-in">
            <div className="bg-white p-6 rounded-lg shadow">
              <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                <FileSpreadsheet className="text-green-600" /> 엑셀 파일 업로드
              </h2>
              
              {!excelFile ? (
                <div 
                  className="border-2 border-dashed border-gray-300 rounded-lg p-10 text-center hover:bg-gray-50 cursor-pointer transition-colors"
                  onClick={() => fileInputRef.current.click()}
                >
                  <Upload className="mx-auto text-gray-400 mb-4" size={48} />
                  <p className="text-lg font-medium text-gray-700">엑셀(.xlsx) 또는 CSV 파일을 여기로 드래그하거나 클릭하세요</p>
                  <p className="text-sm text-gray-500 mt-2">파일 내 열 순서가 달라도 직접 매칭할 수 있습니다.</p>
                  <input 
                    type="file" 
                    accept=".xlsx, .xls, .csv" 
                    ref={fileInputRef} 
                    onChange={handleExcelFileRead} 
                    className="hidden" 
                  />
                </div>
              ) : (
                <div className="flex justify-between items-center bg-green-50 p-4 rounded border border-green-200">
                  <div className="flex items-center gap-3">
                    <div className="bg-white p-2 rounded-full shadow-sm"><CheckCircle className="text-green-600" size={24} /></div>
                    <div>
                      <p className="font-bold text-gray-800">{excelFile}</p>
                      <p className="text-sm text-gray-500">총 {excelRows.length}개 행 발견</p>
                    </div>
                  </div>
                  <button 
                    onClick={() => { setExcelFile(null); setExcelRows([]); setColumnMapping({}); }}
                    className="text-gray-500 hover:text-red-500 text-sm underline"
                  >
                    다른 파일 올리기
                  </button>
                </div>
              )}
            </div>

            {excelFile && (
              <div className="flex flex-col lg:flex-row gap-6 h-full min-h-0">
                {/* 왼쪽: 열 매핑 설정 */}
                <div className="w-full lg:w-1/3 bg-white p-4 rounded-lg shadow overflow-y-auto">
                  <div className="mb-4 pb-2 border-b">
                    <h3 className="font-bold text-lg">데이터 열 매칭</h3>
                    <p className="text-xs text-gray-500">엑셀 파일의 열(Header)을 프로그램 항목과 연결해주세요.</p>
                  </div>
                  
                  <div className="space-y-3">
                    {FIELD_DEFINITIONS.map(field => (
                      <div key={field.key} className="flex flex-col">
                        <label className="text-sm font-medium text-gray-700 mb-1 flex justify-between">
                          {field.label}
                          {field.required && <span className="text-red-500 text-xs">*필수</span>}
                        </label>
                        <select 
                          value={columnMapping[field.key]} 
                          onChange={(e) => setColumnMapping({...columnMapping, [field.key]: e.target.value === '' ? '' : Number(e.target.value)})}
                          className={`w-full p-2 border rounded text-sm ${field.required && !columnMapping[field.key] && columnMapping[field.key] !== 0 ? 'border-red-300 bg-red-50' : 'border-gray-300'}`}
                        >
                          <option value="">(선택 안 함)</option>
                          {excelHeaders.map((header, idx) => (
                            <option key={idx} value={idx}>{header || `[열 ${idx+1}]`}</option>
                          ))}
                        </select>
                      </div>
                    ))}
                  </div>

                  <div className="mt-6 pt-4 border-t">
                    <button 
                      onClick={handleApplyMappedData}
                      className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 flex justify-center items-center gap-2 shadow-lg transition-transform transform active:scale-95"
                    >
                      데이터 적용 및 이동 <ArrowRight size={18} />
                    </button>
                  </div>
                </div>

                {/* 오른쪽: 미리보기 */}
                <div className="w-full lg:w-2/3 bg-white p-4 rounded-lg shadow flex flex-col">
                  <h3 className="font-bold text-lg mb-2">데이터 미리보기 (상위 5개)</h3>
                  <div className="flex-1 overflow-auto border rounded bg-gray-50">
                    <table className="w-full text-sm border-collapse">
                      <thead className="bg-gray-100 text-gray-600">
                        <tr>
                          {excelHeaders.map((header, idx) => (
                            <th key={idx} className="border p-2 min-w-[100px] text-left">
                              <div className="flex flex-col">
                                <span>{header || `[열 ${idx+1}]`}</span>
                                {Object.keys(columnMapping).find(k => columnMapping[k] === idx) && (
                                  <span className="text-xs text-indigo-600 bg-indigo-100 px-1 rounded w-fit mt-1">
                                    → {FIELD_DEFINITIONS.find(f => f.key === Object.keys(columnMapping).find(k => columnMapping[k] === idx))?.label}
                                  </span>
                                )}
                              </div>
                            </th>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        {excelRows.slice(0, 5).map((row, rIdx) => (
                          <tr key={rIdx} className="bg-white border-b hover:bg-gray-50">
                            {excelHeaders.map((_, cIdx) => (
                              <td key={cIdx} className="border p-2 truncate max-w-[150px]" title={row[cIdx]}>
                                {row[cIdx]}
                              </td>
                            ))}
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {/* 3. 데이터 입력 탭 */}
        {activeTab === 'input' && (
          <div className="flex flex-col h-full bg-white rounded-lg shadow overflow-hidden animate-fade-in">
            <div className="p-4 border-b flex flex-wrap justify-between items-center bg-gray-50 gap-2">
              <div className="flex items-center gap-2">
                <span className="font-bold text-lg text-gray-700">학생 데이터 리스트</span>
                <span className="text-sm text-gray-500 bg-gray-200 px-2 py-0.5 rounded">총 {students.length}명</span>
                <span className={`text-xs px-2 py-1 rounded ml-2 border ${modelType === 'pro' ? 'bg-purple-100 text-purple-700 border-purple-200' : 'bg-yellow-100 text-yellow-800 border-yellow-200'}`}>
                  모델: {MODELS[modelType].name}
                </span>
              </div>
              <div className="flex gap-2">
                <button onClick={() => handleAddRow(1)} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm flex items-center gap-1">
                  <Plus size={16} /> 행 추가
                </button>
                <button 
                  onClick={generateSeTeuk}
                  disabled={isGenerating}
                  className="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 text-sm flex items-center gap-1 font-bold shadow-sm"
                >
                  <Play size={16} /> 세특 생성 시작
                </button>
              </div>
            </div>
            
            <div className="flex-1 overflow-auto">
              {students.length === 0 ? (
                <div className="h-full flex flex-col items-center justify-center text-gray-400 gap-4">
                  <Table size={48} className="opacity-20" />
                  <p>데이터가 없습니다. 행을 추가하거나 엑셀 탭에서 파일을 업로드하세요.</p>
                  <button onClick={() => setActiveTab('upload')} className="text-indigo-600 font-bold hover:underline">엑셀 업로드 탭으로 이동</button>
                </div>
              ) : (
                <table className="w-full border-collapse min-w-[1800px]">
                  <thead className="bg-gray-100 sticky top-0 z-10">
                    <tr>
                      <th className="border p-2 w-12 text-center sticky left-0 bg-gray-100 z-20">삭제</th>
                      <th className="border p-2 w-16 text-center sticky left-12 bg-gray-100 z-20">학년</th>
                      <th className="border p-2 w-16 text-center sticky left-28 bg-gray-100 z-20">반</th>
                      <th className="border p-2 w-16 text-center sticky left-44 bg-gray-100 z-20">번호</th>
                      <th className="border p-2 w-24 text-center sticky left-60 bg-gray-100 z-20 shadow-r">이름</th>
                      <th className="border p-2 min-w-[200px]">교과 성취기준</th>
                      <th className="border p-2 w-20">중간</th>
                      <th className="border p-2 w-20">기말</th>
                      <th className="border p-2 min-w-[200px] bg-blue-50">수행1 성취기준</th>
                      <th className="border p-2 min-w-[250px] bg-blue-50">수행1 활동내용</th>
                      <th className="border p-2 min-w-[200px] bg-green-50">수행2 성취기준</th>
                      <th className="border p-2 min-w-[250px] bg-green-50">수행2 활동내용</th>
                      <th className="border p-2 min-w-[150px]">비고</th>
                      <th className="border p-2 min-w-[200px] bg-yellow-50">개별 추가 프롬프트</th>
                    </tr>
                  </thead>
                  <tbody>
                    {students.map((student, index) => (
                      <tr key={student.id} className="hover:bg-gray-50 group">
                        <td className="border p-2 text-center sticky left-0 bg-white group-hover:bg-gray-50 z-10">
                          <button onClick={() => handleRemoveRow(student.id)} className="text-red-400 hover:text-red-600">
                            <Trash2 size={16} />
                          </button>
                        </td>
                        <td className="border p-0 sticky left-12 bg-white group-hover:bg-gray-50 z-10">
                          <input type="text" className="w-full h-full p-2 text-center outline-none bg-transparent" value={student.grade} onChange={(e) => handleInputChange(student.id, 'grade', e.target.value)} />
                        </td>
                        <td className="border p-0 sticky left-28 bg-white group-hover:bg-gray-50 z-10">
                          <input type="text" className="w-full h-full p-2 text-center outline-none bg-transparent" value={student.classNum} onChange={(e) => handleInputChange(student.id, 'classNum', e.target.value)} />
                        </td>
                        <td className="border p-0 sticky left-44 bg-white group-hover:bg-gray-50 z-10">
                          <input type="text" className="w-full h-full p-2 text-center outline-none bg-transparent" value={student.number} onChange={(e) => handleInputChange(student.id, 'number', e.target.value)} />
                        </td>
                        <td className="border p-0 sticky left-60 bg-white group-hover:bg-gray-50 z-10 shadow-r">
                          <input type="text" className="w-full h-full p-2 text-center font-medium outline-none bg-transparent" value={student.name} onChange={(e) => handleInputChange(student.id, 'name', e.target.value)} placeholder="이름" />
                        </td>
                        {/* 데이터 컬럼들 */}
                        <td className="border p-0"><textarea className="w-full h-full p-2 outline-none resize-none bg-transparent text-sm" rows={2} value={student.standard} onChange={(e) => handleInputChange(student.id, 'standard', e.target.value)} placeholder="핵심 성취기준" /></td>
                        <td className="border p-0"><input type="text" className="w-full h-full p-2 text-center outline-none bg-transparent" value={student.midterm} onChange={(e) => handleInputChange(student.id, 'midterm', e.target.value)} /></td>
                        <td className="border p-0"><input type="text" className="w-full h-full p-2 text-center outline-none bg-transparent" value={student.final} onChange={(e) => handleInputChange(student.id, 'final', e.target.value)} /></td>
                        <td className="border p-0 bg-blue-50/30"><textarea className="w-full h-full p-2 outline-none resize-none bg-transparent text-sm" rows={2} value={student.perf1Std} onChange={(e) => handleInputChange(student.id, 'perf1Std', e.target.value)} /></td>
                        <td className="border p-0 bg-blue-50/30"><textarea className="w-full h-full p-2 outline-none resize-none bg-transparent text-sm" rows={2} value={student.perf1Act} onChange={(e) => handleInputChange(student.id, 'perf1Act', e.target.value)} placeholder="발표, 보고서 등 활동 내용" /></td>
                        <td className="border p-0 bg-green-50/30"><textarea className="w-full h-full p-2 outline-none resize-none bg-transparent text-sm" rows={2} value={student.perf2Std} onChange={(e) => handleInputChange(student.id, 'perf2Std', e.target.value)} /></td>
                        <td className="border p-0 bg-green-50/30"><textarea className="w-full h-full p-2 outline-none resize-none bg-transparent text-sm" rows={2} value={student.perf2Act} onChange={(e) => handleInputChange(student.id, 'perf2Act', e.target.value)} /></td>
                        <td className="border p-0"><textarea className="w-full h-full p-2 outline-none resize-none bg-transparent text-sm" rows={2} value={student.note} onChange={(e) => handleInputChange(student.id, 'note', e.target.value)} /></td>
                        <td className="border p-0 bg-yellow-50/30"><textarea className="w-full h-full p-2 outline-none resize-none bg-transparent text-sm" rows={2} value={student.customPrompt} onChange={(e) => handleInputChange(student.id, 'customPrompt', e.target.value)} placeholder="이 학생만 특별히 강조할 점" /></td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              )}
            </div>
          </div>
        )}

        {/* 4. 결과 탭 */}
        {activeTab === 'result' && (
          <div className="flex flex-col h-full gap-4 animate-fade-in">
            {/* 진행 상태 및 요약 */}
            <div className="bg-white p-4 rounded-lg shadow">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-bold flex items-center gap-2">
                  생성 결과 
                  {isGenerating && <span className="text-sm font-normal text-blue-600 animate-pulse">(생성 중... {generationProgress}%)</span>}
                </h2>
                <div className="text-right text-sm">
                  <div className="font-medium text-gray-700">
                    총 토큰 비용 추산 ({MODELS[modelType].name})
                  </div>
                  <div className="flex gap-4 text-gray-600 mt-1 bg-gray-100 px-3 py-1 rounded justify-end items-center">
                    <span>입력: {totalUsage.input.toLocaleString()} tokens</span>
                    <span>출력: {totalUsage.output.toLocaleString()} tokens</span>
                    <span className="font-bold text-indigo-600 text-lg ml-2">예상 비용: ${totalCost.toFixed(5)}</span>
                  </div>
                </div>
              </div>

              {/* 비용 설명 */}
              <div className="text-xs text-gray-400 flex flex-col gap-1 mb-2 items-end">
                <div className="flex items-center gap-1">
                  <Info size={12} />
                  <span>현재 모델: {MODELS[modelType].name} (Input ${MODELS[modelType].costInput}/1M, Output ${MODELS[modelType].costOutput}/1M)</span>
                </div>
              </div>
            </div>

            {/* 결과 카드 리스트 */}
            <div className="flex-1 overflow-auto grid grid-cols-1 lg:grid-cols-2 gap-4 pb-10">
              {results.length === 0 && !isGenerating && (
                <div className="col-span-2 text-center py-20 text-gray-400">
                  데이터 입력 탭에서 '세특 생성 시작' 버튼을 눌러주세요.
                </div>
              )}
              
              {results.map((result, idx) => (
                <div key={idx} className={`bg-white rounded-lg shadow border p-4 flex flex-col ${result.status === 'error' ? 'border-red-200 bg-red-50' : 'border-gray-200'}`}>
                  <div className="flex justify-between items-start mb-3 border-b pb-2">
                    <div>
                      <span className="text-lg font-bold text-gray-800 mr-2">{result.info.name}</span>
                      <span className="text-sm text-gray-500">{result.info.grade}학년 {result.info.classNum}반 {result.info.number}번</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <span className="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded">
                        In: {result.usage?.promptTokenCount} / Out: {result.usage?.candidatesTokenCount}
                      </span>
                      <button 
                        onClick={() => copyToClipboard(result.text)}
                        className="text-gray-400 hover:text-indigo-600 p-1"
                        title="내용 복사"
                      >
                        <Copy size={16} />
                      </button>
                    </div>
                  </div>
                  
                  <div className="flex-1 text-sm text-gray-700 leading-relaxed whitespace-pre-wrap font-sans">
                    {result.text}
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
      </main>
    </div>
  );
};

export default SeTeukGenerator;
